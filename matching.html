<!DOCTYPE html>
<html lang="ko">
<head>
    <script>
        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ (localStorageì— ì‚¬ìš©ì ì •ë³´ê°€ ìˆëŠ”ì§€ í™•ì¸)
        if (!localStorage.getItem('petples_user')) {
            // ë¡œê·¸ì¸ë˜ì§€ ì•Šì•˜ì„ ê²½ìš° ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = 'login.html'; // ë¡œê·¸ì¸ í˜ì´ì§€ URLë¡œ ë³€ê²½
        }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚°ì±… ë©”ì´íŠ¸ ì°¾ê¸° - í«í”ŒìŠ¤</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* íƒ­ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        .tab-button { padding: 10px 20px; cursor: pointer; background: none; border: none; font-size: 16px; font-weight: 500; color: #888; }
        .tab-button.active { color: #ff7f50; border-bottom: 2px solid #ff7f50; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        /* ì°¨ë‹¨ ëª©ë¡ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .blocked-user-list li { display: flex; align-items: center; gap: 15px; }
        .blocked-user-list img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        .blocked-user-list .user-details { flex-grow: 1; }
        .unblock-btn { padding: 5px 10px; border: 1px solid #ccc; background-color: #f8f8f8; cursor: pointer; border-radius: 4px; }

    </style>
</head>
<body>

    <!-- í—¤ë”: ë¡œê³ ì™€ ë„¤ë¹„ê²Œì´ì…˜ -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <img src="images/app_icon.png" alt="í«í”ŒìŠ¤ ì•± ì•„ì´ì½˜">
                <h1><a href="index.html">í«í”ŒìŠ¤</a></h1>
            </div>
            <nav class="nav">
                <ul id="nav-menu">
                    <!-- js/auth.jsê°€ ë™ì ìœ¼ë¡œ ë©”ë‰´ë¥¼ ì±„ì›ë‹ˆë‹¤. -->
                </ul>
            </nav>
        </div>
    </header>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <main class="main-content">
        <div class="container">
            <section>
                <div class="tabs">
                    <button class="tab-button active" onclick="openTab(event, 'Matching')">ì¶”ì²œ</button>
                    <button class="tab-button" onclick="openTab(event, 'Blocked')">ì°¨ë‹¨ ëª©ë¡</button>
                </div>

                <!-- ì¶”ì²œ íƒ­ -->
                <div id="Matching" class="tab-content active">
                    <h2>ğŸ¤ ì‚°ì±… ë©”ì´íŠ¸ë¥¼ ì°¾ì•„ë³´ì„¸ìš”!</h2>
                    <div class="matching-container">
                    <div class="card-stack">
                        <!-- ì¹´ë“œ ëª©ë¡ -->
                        <div class="card">
                            <img src="images/siba.png" alt="ì‹œë°”ê²¬">
                            <div class="card-info">
                                <div class="card-info-header">
                                    <h3>ì½©ì´, 2</h3>
                                    <div class="manner-temp">
                                        <span>37.2â„ƒ</span>
                                        <progress value="37.2" max="100"></progress>
                                    </div>
                                </div>
                                <p>ì‹œë°”ê²¬ | ì—¬ì•„</p>
                            </div>
                        </div>
                        <div class="card">
                            <img src="images/pome.png" alt="í¬ë©”ë¼ë‹ˆì•ˆ">
                            <div class="card-info">
                                <div class="card-info-header">
                                    <h3>ë­‰ì¹˜, 1</h3>
                                    <div class="manner-temp">
                                        <span>36.5â„ƒ</span>
                                        <progress value="36.5" max="100"></progress>
                                    </div>
                                </div>
                                <p>í¬ë©”ë¼ë‹ˆì•ˆ | ë‚¨ì•„</p>
                            </div>
                        </div>
                        <div class="card">
                            <img src="images/daks.png" alt="ë‹¥ìŠ¤í›ˆíŠ¸">
                            <div class="card-info">
                                <div class="card-info-header">
                                    <h3>ì´ˆì½”, 5</h3>
                                    <div class="manner-temp">
                                        <span>38.1â„ƒ</span>
                                        <progress value="38.1" max="100"></progress>
                                    </div>
                                </div>
                                <p>ë‹¥ìŠ¤í›ˆíŠ¸ | ì—¬ì•„</p>
                            </div>
                        </div>
                        <div class="card">
                            <img src="images/rit.png" alt="ë¦¬íŠ¸ë¦¬ë²„">
                            <div class="card-info">
                                <div class="card-info-header">
                                    <h3>ë¦¬íŠ¸ë¦¬ë²„, 3</h3>
                                    <div class="manner-temp">
                                        <span>36.8â„ƒ</span>
                                        <progress value="36.8" max="100"></progress>
                                    </div>
                                </div>
                                <p>ê³¨ë“  ë¦¬íŠ¸ë¦¬ë²„ | ë‚¨ì•„</p>
                            </div>
                        </div>
                        <div class="card">
                            <img src="images/beagle.png" alt="ë¹„ê¸€">
                            <div class="card-info">
                                <div class="card-info-header">
                                    <h3>ì—¬ë¦„ì´, 2</h3>
                                    <div class="manner-temp">
                                        <span>35.9â„ƒ</span>
                                        <progress value="35.9" max="100"></progress>
                                    </div>
                                </div>
                                <p>ë¹„ê¸€ | ì—¬ì•„</p>
                            </div>
                        </div>
                        <div class="card">
                            <img src="images/parrot.png" alt="ì•µë¬´ìƒˆ">
                            <div class="card-info">
                                <div class="card-info-header">
                                    <h3>ì½”ì½”, 3</h3>
                                </div>
                                <p>ëª¨ë€ì•µë¬´ | ë‚¨ì•„</p>
                            </div>
                        </div>
                        <div class="card">
                            <img src="images/corgi.png" alt="ì›°ì‹œì½”ê¸°">
                            <div class="card-info">
                                <div class="card-info-header">
                                    <h3>ë§ˆë£¨, 4</h3>
                                    <div class="manner-temp">
                                        <span>39.0â„ƒ</span>
                                        <progress value="39.0" max="100"></progress>
                                    </div>
                                </div>
                                <p>ì›°ì‹œì½”ê¸° | ë‚¨ì•„</p>
                            </div>
                        </div>
                        <p id="no-more-cards">ë” ì´ìƒ ì¶”ì²œí•  ì¹œêµ¬ê°€ ì—†ì–´ìš”!</p>
                    </div>
                        <div class="action-buttons">
                            <button class="btn-dislike" title="ì‹«ì–´ìš”">âŒ</button>
                            <button class="btn-block" title="ì°¨ë‹¨">ğŸš«</button>
                            <button class="btn-like" title="ì¢‹ì•„ìš”">ğŸ’š</button>
                            <button class="btn-superlike" title="ìŠˆí¼ë¼ì´í¬">â­</button>
                        </div>
                    </div>
                </div>

                <!-- ì°¨ë‹¨ ëª©ë¡ íƒ­ -->
                <div id="Blocked" class="tab-content">
                    <h2>ğŸš« ì°¨ë‹¨ëœ ì‚¬ìš©ì</h2>
                    <ul id="blocked-list" class="blocked-user-list">
                        <!-- ì°¨ë‹¨ëœ ì‚¬ìš©ìê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. -->
                    </ul>
                </div>
            </section>
        </div>
    </main>

    <!-- í‘¸í„°: ì €ì‘ê¶Œ ë° ê¸°íƒ€ ì •ë³´ -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Petples. All Rights Reserved.</p>
            <p>íšŒì‚¬ì†Œê°œ | ì´ìš©ì•½ê´€ | ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</p>
        </div>
    </footer>

    <script src="auth.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const cardStack = document.querySelector('.card-stack');
        const noMoreCardsMsg = document.getElementById('no-more-cards');
        const blockedListUl = document.getElementById('blocked-list');

        let activeCard = null;
        let startX = 0, startY = 0;
        let isDragging = false;
        let blockedUsers = JSON.parse(localStorage.getItem('blocked_users')) || [];
        const currentUser = JSON.parse(localStorage.getItem('petples_user'));
        const preferredBreed = currentUser ? currentUser.preferred_breed.toLowerCase() : '';
        let allCards = [];

        function initCards() {
            if (allCards.length === 0) { // ìµœì´ˆ ë¡œë“œ ì‹œì—ë§Œ ì¹´ë“œ ëª©ë¡ì„ ê°€ì ¸ì˜´
                allCards = Array.from(cardStack.querySelectorAll('.card'));

                // ì„ í˜¸ í’ˆì¢…ì— ë”°ë¼ ì¹´ë“œ ì •ë ¬
                if (preferredBreed && preferredBreed !== 'ë¯¸ì…ë ¥') {
                    allCards.sort((a, b) => {
                        const breedA = a.querySelector('p').textContent.toLowerCase();
                        const breedB = b.querySelector('p').textContent.toLowerCase();
                        const aIsPreferred = breedA.includes(preferredBreed);
                        const bIsPreferred = breedB.includes(preferredBreed);

                        if (aIsPreferred && !bIsPreferred) return -1; // aë¥¼ ì•ìœ¼ë¡œ
                        if (!aIsPreferred && bIsPreferred) return 1;  // bë¥¼ ì•ìœ¼ë¡œ
                        return 0; // ìˆœì„œ ìœ ì§€
                    });
                }
            }

            // ë³´ì´ëŠ” ì¹´ë“œë§Œ í•„í„°ë§
            const visibleCards = allCards.filter(card => {
                if (!card.parentElement) return false; // DOMì—ì„œ ì œê±°ëœ ì¹´ë“œëŠ” ì œì™¸
                const dogName = card.querySelector('h3').textContent.split(',')[0];
                // ì°¨ë‹¨ ëª©ë¡ì— ì´ë¦„ì´ ì—†ëŠ” ì¹´ë“œë§Œ í•„í„°ë§
                return !blockedUsers.some(user => user.name === dogName);
            });

            // ëª¨ë“  ì¹´ë“œë¥¼ ì¼ë‹¨ ìˆ¨ê¹ë‹ˆë‹¤.
            allCards.forEach(card => card.style.display = 'none');

            if (visibleCards.length > 0) {
                // ë³´ì—¬ì¤„ ì¹´ë“œë“¤ë§Œ ë‹¤ì‹œ í™”ë©´ì— í‘œì‹œí•©ë‹ˆë‹¤.
                // ë¨¼ì € ëª¨ë“  ì¹´ë“œì—ì„œ ìŠ¤íƒ íš¨ê³¼ í´ë˜ìŠ¤ë¥¼ ì œê±°í•˜ê³  transformì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
                allCards.forEach(card => {
                    card.classList.remove('stacked');
                    card.style.transform = '';
                });

                visibleCards.forEach((card, index) => {
                    card.style.display = 'flex'; // flexë¡œ ë‹¤ì‹œ ë³´ì´ê²Œ í•¨
                    card.style.zIndex = visibleCards.length - index; // z-index ì¬ì„¤ì •
                    // ë³´ì´ëŠ” ì¹´ë“œ ì¤‘ 2ë²ˆì§¸, 3ë²ˆì§¸ ì¹´ë“œì—ë§Œ ìŠ¤íƒ íš¨ê³¼ë¥¼ ë‹¤ì‹œ ì ìš©í•©ë‹ˆë‹¤.
                    if (index === 1 || index === 2) {
                        card.classList.add('stacked');
                    }
                });
                
                // activeCardë¥¼ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •í•©ë‹ˆë‹¤.
                activeCard = visibleCards[0];
                noMoreCardsMsg.style.display = 'none';
                attachEventListeners(activeCard);
            } else {
                activeCard = null;
                noMoreCardsMsg.style.display = 'block';
            }
            renderBlockedList();
        }

        function renderBlockedList() {
            blockedListUl.innerHTML = '';
            if (blockedUsers.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'ì°¨ë‹¨í•œ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.';
                blockedListUl.appendChild(li);
            } else {
                blockedUsers.forEach(user => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <img src="${user.imgSrc}" alt="${user.name}">
                        <span class="user-details">${user.name}</span>
                        <button class="unblock-btn" data-name="${user.name}">ì°¨ë‹¨ í•´ì œ</button>`;
                    blockedListUl.appendChild(li);
                });
            }
        }

        function attachEventListeners(card) {
            card.addEventListener('pointerdown', onDragStart);
            card.addEventListener('pointermove', onDragMove);
            card.addEventListener('pointerup', onDragEnd);
            card.addEventListener('pointerleave', onDragEnd);
        }

        function onDragStart(e) {
            if (!activeCard) return;
            isDragging = true;
            startX = e.pageX;
            startY = e.pageY;
            activeCard.classList.add('dragging');
        }

        function onDragMove(e) {
            if (!isDragging || !activeCard) return;
            const currentX = e.pageX;
            const deltaX = currentX - startX;
            const rotate = deltaX * 0.1; // ìŠ¤ì™€ì´í”„ ê±°ë¦¬ì— ë”°ë¼ íšŒì „
            activeCard.style.transform = `translateX(${deltaX}px) rotate(${rotate}deg)`;
        }

        function onDragEnd(e) {
            if (!isDragging || !activeCard) return;
            isDragging = false;
            activeCard.classList.remove('dragging');

            const deltaX = e.pageX - startX;
            const deltaY = e.pageY - startY;
            const decisionThreshold = 100; // ì´ ê±°ë¦¬ ì´ìƒ ì›€ì§ì´ë©´ ê²°ì •

            if (Math.abs(deltaX) > decisionThreshold) {
                const direction = deltaX > 0 ? 1 : -1;
                if (direction === 1) { // ì˜¤ë¥¸ìª½ ìŠ¤ì™€ì´í”„ (Like)
                    openChat(activeCard);
                }
                swipeCard(direction); // ì™¼ìª½ ë˜ëŠ” ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì¹´ë“œ ë‚ ë¦¬ê¸°
            } else if (deltaY < -decisionThreshold) { // ìœ„ë¡œ ìŠ¤ì™€ì´í”„ (SuperLike)
                openChat(activeCard);
                superLikeCard();
            } else {
                // ì›ë˜ ìœ„ì¹˜ë¡œ ë³µê·€
                activeCard.style.transform = '';
            }
        }

        function swipeCard(direction) {
            if (!activeCard) return;

            const endX = (window.innerWidth / 2) * direction;
            const flyOutAngle = direction * 15;
            
            activeCard.style.transition = 'transform 0.5s ease-out';
            activeCard.style.transform = `translateX(${endX}px) rotate(${flyOutAngle}deg)`;
            
            // ì¹´ë“œê°€ ì‚¬ë¼ì§„ í›„ ì²˜ë¦¬
            activeCard.addEventListener('transitionend', () => {
                activeCard.remove();
                initCards();
            }, { once: true });
        }

        function superLikeCard() {
            if (!activeCard) return;

            // ìŠˆí¼ ë¼ì´í¬ ì• ë‹ˆë©”ì´ì…˜: ìœ„ë¡œ ì†Ÿì•„ì˜¤ë¥´ë©° ì‚¬ë¼ì§
            activeCard.style.transition = 'transform 0.5s ease-in, opacity 0.5s ease-in';
            activeCard.style.transform = 'translateY(-100vh) rotate(0deg)';
            activeCard.style.opacity = '0';

            // ì¹´ë“œê°€ ì‚¬ë¼ì§„ í›„ ì²˜ë¦¬
            activeCard.addEventListener('transitionend', () => {
                activeCard.remove();
                initCards();
            }, { once: true });
        }

        function openChat(card) {
            const dogName = card.querySelector('h3').textContent.split(',')[0];
            if (confirm(`${dogName}ë‹˜ê³¼ ëŒ€í™”ë¥¼ ì‹œì‘í• ê¹Œìš”?`)) {
                // localStorageì— ì±„íŒ…ë°© ì •ë³´ ì €ì¥
                const chatRooms = JSON.parse(localStorage.getItem('petples_chat_rooms')) || [];
                const dogImgSrc = card.querySelector('img').src;

                // ì´ë¯¸ ì±„íŒ…ë°©ì´ ìˆëŠ”ì§€ í™•ì¸
                const isExisting = chatRooms.some(room => room.name === dogName);

                if (!isExisting) {
                    const newRoom = {
                        name: dogName,
                        imgSrc: dogImgSrc,
                        lastMessage: 'ë§¤ì¹­ì´ ì„±ì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”.',
                        time: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: true })
                    };
                    chatRooms.unshift(newRoom); // ìƒˆ ì±„íŒ…ë°©ì„ ë§¨ ìœ„ì— ì¶”ê°€
                    localStorage.setItem('petples_chat_rooms', JSON.stringify(chatRooms));
                }
                window.location.href = `chat.html?with=${dogName}`;
            }
        }

        function blockUser() {
            if (!activeCard) return;
            const dogName = activeCard.querySelector('h3').textContent.split(',')[0];
            const dogImgSrc = activeCard.querySelector('img').src;

            // ì´ë¯¸ ì°¨ë‹¨ëœ ì‚¬ìš©ìì¸ì§€ í™•ì¸
            if (!blockedUsers.some(user => user.name === dogName)) {
                blockedUsers.push({ name: dogName, imgSrc: dogImgSrc });
                localStorage.setItem('blocked_users', JSON.stringify(blockedUsers));
                alert(`${dogName}ë‹˜ì„ ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤.`);
                renderBlockedList();
            }
            // í˜„ì¬ ì¹´ë“œë¥¼ ì¦‰ì‹œ ì œê±°í•˜ê³  ë‹¤ìŒ ì¹´ë“œë¥¼ ì¤€ë¹„
            activeCard.remove();
            initCards();
        }

        // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.querySelector('.btn-dislike').addEventListener('click', () => swipeCard(-1));

        document.querySelector('.btn-like').addEventListener('click', () => {
            if (!activeCard) return;
            openChat(activeCard);
            swipeCard(1);
        });

        document.querySelector('.btn-superlike').addEventListener('click', () => {
            if (!activeCard) return;
            openChat(activeCard);
            superLikeCard();
        });

        document.querySelector('.btn-block').addEventListener('click', blockUser);

        blockedListUl.addEventListener('click', (e) => {
            if (e.target.classList.contains('unblock-btn')) {
                const nameToUnblock = e.target.dataset.name;
                blockedUsers = blockedUsers.filter(user => user.name !== nameToUnblock);
                localStorage.setItem('blocked_users', JSON.stringify(blockedUsers));
                alert(`${nameToUnblock}ë‹˜ì„ ì°¨ë‹¨ í•´ì œí–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ ì‹œ ì¶”ì²œ ëª©ë¡ì— ë‹¤ì‹œ ë‚˜íƒ€ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                renderBlockedList();
                // ì°¨ë‹¨ í•´ì œ í›„ ì¶”ì²œ ëª©ë¡ì„ ë‹¤ì‹œ ë¡œë“œí•˜ë ¤ë©´ initCards()ë¥¼ í˜¸ì¶œí•˜ê±°ë‚˜ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì•¼ í•©ë‹ˆë‹¤.
            }
        });

        initCards();
    });

    // íƒ­ ê¸°ëŠ¥
    function openTab(evt, tabName) {
        let i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tab-button");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }
    </script>
</body>
</html>